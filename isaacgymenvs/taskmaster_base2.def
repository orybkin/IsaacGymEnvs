# A simpler config that doesn't use ./create_conda_env_rlgpu.sh
Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04

%files
    ./IsaacGym_Preview_4_Package.tar.gz /home/IsaacGym_Preview_4_Package.tar.gz

# Container setup
%post -c /bin/bash 
    # Install conda
    apt update
    cd /home
    apt install wget -y
    apt install parallel -y
    apt install vim -y
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /home/miniconda3
    export PATH="/home/miniconda3/bin:$PATH"
    . /home/miniconda3/etc/profile.d/conda.sh

    # Install Isaac
    conda create -n cubes python=3.7
    conda activate cubes
    conda install pytorch==1.12.0 torchvision==0.13.0 torchaudio==0.12.0 cudatoolkit=11.3 -c pytorch
    tar -xvf IsaacGym_Preview_4_Package.tar.gz
    cd isaacgym/python
    pip install -e .
    cd ../..

    # Install taskmaster dependencies
    apt-get install git -y
    mkdir -p /global/scratch/user/oleh/
    cd /global/scratch/user/oleh/
    GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" git clone https://github.com/orybkin/taskmaster.git
    cd taskmaster
    pip install -e .

%environment
    . /home/miniconda3/etc/profile.d/conda.sh
    conda activate cubes
    export LD_LIBRARY_PATH=/home/miniconda3/envs/cubes/lib/:$LD_LIBRARY_PATH
    cd /global/scratch/users/oleh/taskmaster
    pip install -e . 
    cd isaacgymenvs
