Bootstrap: localimage
From: ./taskmaster.sif

# Container setup
%post -c /bin/bash 
    apt install mesa-utils ffmpeg libgl1 libosmesa6-dev libgl1-mesa-glx libglfw3-dev libglew-dev patchelf -y

    . /home/miniconda3/etc/profile.d/conda.sh
    conda activate cubes
    conda install -n base conda-libmamba-solver
    conda config --set solver libmamba
    conda install -c conda-forge matplotlib gcc=12.1.0 libstdcxx-ng=12 glew mesalib patchelf
    conda install -c anaconda mesa-libgl-cos6-x86_64
    conda install -c menpo glfw3

    apt --fix-broken install -y
    wget https://downloads.sourceforge.net/project/turbovnc/2.2.6/turbovnc_2.2.6_amd64.deb
    dpkg -i turbovnc_2.2.6_amd64.deb

    apt --fix-broken install -y
    wget https://sourceforge.net/projects/virtualgl/files/2.6.4/virtualgl_2.6.4_amd64.deb
    dpkg -i virtualgl_2.6.4_amd64.deb

    export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu/dri:/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
    export LIBGL_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
    apt install libffi-dev